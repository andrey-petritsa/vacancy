from types import SimpleNamespace as sn

from vacancy.parser.deepseek.deepseek_vacansies_parser import DeepSeekVacanciesParser


class TestVacationParser:
    def test_convert(self):
        parser = DeepSeekVacanciesParser()

        vacancy_text_1 = (
            "#–≤–∞–∫–∞–Ω—Å–∏—è #python #—É–¥–∞–ª–µ–Ω–∫–∞ #backend #middle\n"
            "üíº Middle / Middle+ Python/Django —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (B2C, –ø—Ä–æ–µ–∫—Ç Valta)\n\n"
            "–û –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø—Ä–æ–µ–∫—Ç–µ:\n"
            "Valta Pet Products ‚Äî e-commerce –∫–æ–º–ø–∞–Ω–∏—è, —Ä–∞–∑–≤–∏–≤–∞—é—â–∞—è B2C-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ –≤ —Å—Ñ–µ—Ä–µ –∑–æ–æ—Ç–æ–≤–∞—Ä–æ–≤. "
            "–°–µ–π—á–∞—Å –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –Ω–∞ Django, –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∑–∞–Ω–æ–≤–æ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, "
            "–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.\n\n"
            "–°—Ç–µ–∫ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n"
            "Python, Django - –æ—Ç–ª–∏—á–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞, –ø–æ–Ω–∏–º–∞–Ω–∏–µ –µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞\n"
            "Django Ninja –∏–ª–∏ FastAPI - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "Celery - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "PostgreSQL - –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤\n"
            "Redis, RabbitMQ - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "JWT - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (must have)\n"
            "Docker - –±—É–¥–µ—Ç –ø–ª—é—Å–æ–º\n"
            "–í–∞–∂–Ω–æ: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ SOLID –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –û–û–ü.\n\n"
            "–£—Å–ª–æ–≤–∏—è:\n"
            "–í–∏–ª–∫–∞: 200 000 ‚Äì 240 000 ‚ÇΩ (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è)\n"
            "–§–æ—Ä–º–∞—Ç: –ø–æ–ª–Ω–∞—è —É–¥–∞–ª—ë–Ω–∫–∞, –Ω–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∫–∞\n"
            "–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫, –≤–∞–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å 10:00 –¥–æ 13:00 –º—Å–∫\n"
            "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã\n\n"
            "üì© –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–∫–ª–∏–∫–æ–≤: @asyasukhanovarecr"
        )

        vacancy_text_2 = (
            "#–≤–∞–∫–∞–Ω—Å–∏—è #—É–¥–∞–ª–µ–Ω–∫–∞ #Python #ETL #Pandas #Airflow #fulltime #Senior #–†–§ #vacancy #remote\n\n"
            "–ü–æ–∑–∏—Ü–∏—è: Senior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (Python) —Å —É–∫–ª–æ–Ω–æ–º –∑–Ω–∞–Ω–∏–π ETL/ELT/DWH\n"
            "–ü—Ä–æ–µ–∫—Ç: –£—á–∞—Å—Ç–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∫—Ä—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã\n"
            "–õ–æ–∫–∞—Ü–∏—è: —É–¥–∞–ª–µ–Ω–∫–∞ –ø–æ –†–§, —Ç–æ–ª—å–∫–æ –∏–∑ –†–§, —Ä–∞–±–æ—Ç–∞ –ø–æ –ú–°–ö.\n"
            "–£—Ä–æ–≤–µ–Ω—å: senior. –û—Ç 4 –ª–µ—Ç –æ–ø—ã—Ç–∞\n"
            "–û–∫–ª–∞–¥: 250-320 —Ç.—Ä.\n"
            "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: –ø–æ –°–ó –∏–ª–∏ –ò–ü (–æ–±—Å—É–∂–¥–∞–µ–º–æ)\n\n"
            "‚ùóÔ∏è–î–ª—è –ø—Ä–æ–µ–∫—Ç–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è Senior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (Python) —Å —É–∫–ª–æ–Ω–æ–º –∑–Ω–∞–Ω–∏–π ETL/ELT/DWH, "
            "–∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Ä–∞–∑–≤–∏—Ç–∏–µ–º –∫—Ä—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏). "
            "–í –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ —Å —Ö–æ—Ä–æ—à–æ –æ—Ç–ª–∞–∂–µ–Ω–Ω—ã–º–∏ –±–∏–∑–Ω–µ—Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.\n\n"
            "–°—Ç–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞: Python, Pandas, Apache Airflow, –ê—Ä—Ö. –∑–Ω–∞–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ETL/ELT/DWH, "
            "SQL, Gitlab, HTTP (REST, SOAP), JSON/XML/CSV, MQ (Kafka, Artemis), Kubernetes.\n"
            "–ü–æ–ª–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å –Ω–∞ —É–¥–∞–ª–µ–Ω–∫–µ.\n\n"
            "‚ùóÔ∏è–ß—Ç–æ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –¥–µ–ª–∞—Ç—å:\n"
            "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä—É–ø–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∞—É—Ç—Å—Ç–∞—Ñ—Ñ.\n\n"
            "‚ùóÔ∏è–û–∂–∏–¥–∞–µ–º –æ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:\n"
            "- –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–µ –º–µ–Ω–µ–µ 4-—Ö –ª–µ—Ç: Python, Pandas, Apache Airflow, –ê—Ä—Ö. –∑–Ω–∞–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ETL/ELT/DWH, "
            "SQL, Gitlab, HTTP (REST, SOAP), JSON/XML/CSV, MQ (Kafka, Artemis), Kubernetes\n"
            "- –û–ø—ã—Ç –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ä–µ—à–µ–Ω–∏—è\n"
            "- –£–º–µ–Ω–∏–µ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä\n"
            "–ü–ª—é—Å–æ–º –±—É–¥–µ—Ç: Java: JDBC, Spring Integration, MapStruct\n\n"
            "‚ùóÔ∏è–ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞, –ø–∏—à–∏: @HRbestsoft"
        )
        msgs = [sn(id=1, text=vacancy_text_1), sn(id=2, text=vacancy_text_2)]

        vacancies = parser.msgs_to_vacancies(msgs)
        vacancy = vacancies[0]
        print(vacancies)

        assert vacancy.languages == ['Python']
        assert vacancy.salary == {'min': 200000, 'max': 240000}
        assert vacancy.work_mode == 'remote'
        assert len(vacancies) > 1

    def test_convert_small_vacancy(self):
        parser = DeepSeekVacanciesParser()
        msg = {'id': 1, 'text': 'Frontend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (React/TypeScript) –ó–ø 200-250 —Ç—ã—Å—è—á'}
        msgs = [sn(**msg)]
        vacancies = parser.msgs_to_vacancies(msgs)

        vacancy = vacancies[0]
        assert vacancy.salary == {'min': 200000, 'max': 250000}
