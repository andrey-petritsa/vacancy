import pytest
from dotenv import dotenv_values

from business.exceptions.exceptions import NotAVacancyException
from details.parser.deepseek.deepseek_vacansies_parser import DeepSeekVacanciesParser


@pytest.mark.slow
class TestVacationParser:
    def test_parse_one(self):
        token = dotenv_values("back/secrets/.env")['DEEPSEEK_TOKEN']
        parser = DeepSeekVacanciesParser(token)
        vacancy_text = (
            "#–≤–∞–∫–∞–Ω—Å–∏—è #python #—É–¥–∞–ª–µ–Ω–∫–∞ #backend #middle\n"
            "üíº Middle / Middle+ Python/Django —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (B2C, –ø—Ä–æ–µ–∫—Ç Valta)\n\n"
            "–û –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø—Ä–æ–µ–∫—Ç–µ:\n"
            "Valta Pet Products ‚Äî e-commerce –∫–æ–º–ø–∞–Ω–∏—è, —Ä–∞–∑–≤–∏–≤–∞—é—â–∞—è B2C-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ –≤ —Å—Ñ–µ—Ä–µ –∑–æ–æ—Ç–æ–≤–∞—Ä–æ–≤. "
            "–°–µ–π—á–∞—Å –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –Ω–∞ Django, –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∑–∞–Ω–æ–≤–æ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, "
            "–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.\n\n"
            "–°—Ç–µ–∫ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n"
            "Python, Django - –æ—Ç–ª–∏—á–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞, –ø–æ–Ω–∏–º–∞–Ω–∏–µ –µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞\n"
            "Django Ninja –∏–ª–∏ FastAPI - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "Celery - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "PostgreSQL - –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤\n"
            "Redis, RabbitMQ - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\n"
            "JWT - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (must have)\n"
            "Docker - –±—É–¥–µ—Ç –ø–ª—é—Å–æ–º\n"
            "–í–∞–∂–Ω–æ: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ SOLID –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –û–û–ü.\n\n"
            "–£—Å–ª–æ–≤–∏—è:\n"
            "–í–∏–ª–∫–∞: 200 000 ‚Äì 240 000 ‚ÇΩ (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è)\n"
            "–§–æ—Ä–º–∞—Ç: –ø–æ–ª–Ω–∞—è —É–¥–∞–ª—ë–Ω–∫–∞, –Ω–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∫–∞\n"
            "–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫, –≤–∞–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å 10:00 –¥–æ 13:00 –º—Å–∫\n"
            "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã\n\n"
            "üì© –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–∫–ª–∏–∫–æ–≤: @asyasukhanovarecr"
        )
        vacancy = {'text': vacancy_text}
        parsed_vacancy = parser.parse_one(vacancy)
        assert parsed_vacancy['languages'] == ['python']
        assert parsed_vacancy['salary'] == {'min': 200000, 'max': 240000}
        assert parsed_vacancy['work_mode'] == 'remote'

    def test_dont_parse_not_programmer_vacancy(self):
        token = dotenv_values("back/secrets/.env")['DEEPSEEK_TOKEN']
        parser = DeepSeekVacanciesParser(token)
        vacancy = {'text':"–í–∞–∫–∞–Ω–∞—Å–∏—è –±–∞—Ä–∏—Å—Ç—ã –≤ –∏–∑–≤–µ—Å—Ç–Ω—É—é –∫–æ—Ñ–µ–π–Ω—é"}
        with pytest.raises(NotAVacancyException):
            parser.parse_one(vacancy)

    def test_generate_cover_latter(self):
        token = dotenv_values("back/secrets/.env")['DEEPSEEK_TOKEN']
        parser = DeepSeekVacanciesParser(token)
        vacancy = {'text': "#–≤–∞–∫–∞–Ω—Å–∏—è #python #—É–¥–∞–ª–µ–Ω–∫–∞ #backend #middle\nüíº Middle / Middle+ Python/Django —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (B2C, –ø—Ä–æ–µ–∫—Ç Valta)\n\n–û –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø—Ä–æ–µ–∫—Ç–µ:\nValta Pet Products ‚Äî e-commerce –∫–æ–º–ø–∞–Ω–∏—è, —Ä–∞–∑–≤–∏–≤–∞—é—â–∞—è B2C-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ –≤ —Å—Ñ–µ—Ä–µ –∑–æ–æ—Ç–æ–≤–∞—Ä–æ–≤. –°–µ–π—á–∞—Å –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –Ω–∞ Django, –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∑–∞–Ω–æ–≤–æ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.\n\n–°—Ç–µ–∫ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:\nPython, Django - –æ—Ç–ª–∏—á–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞, –ø–æ–Ω–∏–º–∞–Ω–∏–µ –µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞\nDjango Ninja –∏–ª–∏ FastAPI - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\nCelery - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\nPostgreSQL - –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤\nRedis, RabbitMQ - –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ\nJWT - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (must have)\nDocker - –±—É–¥–µ—Ç –ø–ª—é—Å–æ–º\n–í–∞–∂–Ω–æ: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ SOLID –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –û–û–ü.\n\n–£—Å–ª–æ–≤–∏—è:\n–í–∏–ª–∫–∞: 200 000 ‚Äì 240 000 ‚ÇΩ (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è)\n–§–æ—Ä–º–∞—Ç: –ø–æ–ª–Ω–∞—è —É–¥–∞–ª—ë–Ω–∫–∞, –Ω–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∫–∞\n–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫, –≤–∞–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å 10:00 –¥–æ 13:00 –º—Å–∫\n–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã\n\nüì© –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–∫–ª–∏–∫–æ–≤: @asyasukhanovarecr"}
        resume = "–†–µ–∑—é–º–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞. –û–ø—ã—Ç 5 –ª–µ—Ç Python, Django, Flask, Fastapi."

        cover_latter = parser.generate_cover_latter(vacancy, resume)

        print(cover_latter)
        assert cover_latter != None
